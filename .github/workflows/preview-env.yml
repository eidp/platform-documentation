name: preview-environment

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
  issue_comment:
    types: [created]

concurrency:
  group: pr-${{ github.event.number || github.event.issue.number }}
  cancel-in-progress: false

permissions:
  contents: read
  actions: read
  pull-requests: write
  issues: write
  id-token: write
  deployments: write

jobs:
  deploy-preview:
    # Only run on PR events or PR comments (not issue comments)
    if: |
      (github.event_name == 'pull_request' && github.event.action != 'closed') ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request)

    runs-on: kubernetes-runner
    environment:
      name: pr-${{ github.event.number || github.event.issue.number }}
      url: ${{ steps.verify-preview.outputs.url }}

    steps:
      # When triggered by slash commands (issue_comment), we need to check out the PR branch
      # because issue_comment events run from the default branch (security feature)
      - name: Get PR branch
        if: github.event_name == 'issue_comment'
        uses: xt0rted/pull-request-comment-branch@e8b8daa837e8ea7331c0003c9c316a64c6d8b0b1 # v3.0.0
        id: comment-branch

      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          # Use PR branch when triggered by slash command, otherwise use the default ref
          ref: ${{ github.event_name == 'issue_comment' && steps.comment-branch.outputs.head_ref || github.ref }}

      # This step fetches the semantic version based on the commit history.
      # The same version should be used to tag the Helm chart, in case your repository contains one.
      - name: Fetch commit version
        id: commit-version
        uses: eidp/actions-semver/fetch-commit-version@d4f33761d7dafbeff3241fe8afe927a1d7516703 # v0.4.0
        with:
          workflow-name: build  # The name of the workflow that builds the artifacts Docker container / Helm chart

      - name: Create Kubernetes context
        id: create-context
        uses: eidp/actions-kubernetes/create-context@fa469cb6b7f371998f500b1adefb4c5372a5f678 # v1.0.0
        with:
          # This references the development cluster. Preview environments are typically deployed to a development cluster.
          cluster: development
          api-server: ${{ vars.K8S_API_SERVER_DEVELOPMENT }}
          certificate-authority-data:
            ${{ secrets.K8S_CERTIFICATE_AUTHORITY_DATA_DEVELOPMENT }}

      - name: Deploy preview
        id: deploy-preview
        uses: eidp/actions-kubernetes/deploy-preview@fa469cb6b7f371998f500b1adefb4c5372a5f678 # v1.0.0
        with:
          # This references the GitHub environment for this PR, not the target cluster environment.
          environment: 'pr-${{ github.event.number || github.event.issue.number }}'
          kubernetes-context: ${{ steps.create-context.outputs.context-name }}
          chart-version: '${{ steps.commit-version.outputs.version }}'
          tenant-name: platform-documentation
          reference: ${{ github.event.number || github.event.issue.number }}
          github-token: ${{ github.token }}

      - name: Verify preview deployment
        id: verify-preview
        if: github.event_name != 'issue_comment' || steps.deploy-preview.outputs.namespace != ''
        uses: eidp/actions-kubernetes/verify-up@fa469cb6b7f371998f500b1adefb4c5372a5f678 # v1.0.0
        with:
          environment: 'pr-${{ github.event.number || github.event.issue.number }}'
          kubernetes-context: ${{ steps.create-context.outputs.context-name }}
          namespace: ${{ steps.deploy-preview.outputs.namespace }}
          flux-resource: helmrelease/platform-documentation
          chart-version: '${{ steps.commit-version.outputs.version }}'
          github-token: ${{ github.token }}

  teardown-preview:
    # Run when: PR is closed, issue comment on PR, or PR has 'dependencies' label
    if: |
      (github.event_name == 'pull_request' && github.event.action == 'closed') ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request) ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'dependencies'))
    runs-on: kubernetes-runner
    steps:
      - name: Create Kubernetes context
        id: create-context
        uses: eidp/actions-kubernetes/create-context@fa469cb6b7f371998f500b1adefb4c5372a5f678 # v1.0.0
        with:
          cluster: development
          api-server: ${{ vars.K8S_API_SERVER_DEVELOPMENT }}
          certificate-authority-data:
            ${{ secrets.K8S_CERTIFICATE_AUTHORITY_DATA_DEVELOPMENT }}

      - name: Teardown preview
        uses: eidp/actions-kubernetes/teardown-preview@fa469cb6b7f371998f500b1adefb4c5372a5f678 # v1.0.0
        with:
          kubernetes-context: ${{ steps.create-context.outputs.context-name }}
          reference: ${{ github.event.number || github.event.issue.number }}
          github-token: ${{ github.token }}
