name: build

on:
  pull_request:
    branches:
    - main
  push:
    branches:
    - main

jobs:
  build:
    runs-on: dind-runner

    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v5.0.0

    - name: Setup Node.js
      uses: actions/setup-node@v4.4.0
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run Prettier format check
      run: npm run format:check

    - name: Run Markdown linting
      run: npm run lint:md

    - name: Build static site
      run: npm run build

    - name: Docker build and push
      id: docker-build-push
      uses: eidp/actions-docker/docker-build-push@0bf2ae59c118baaf120ad42b78bc13ecb155ff94
      with:
        image: ${{ vars.HARBOR_HOST }}/platform-documentation
        registry: ${{ vars.HARBOR_HOST }}
        registry-username: ${{ secrets.HARBOR_USERNAME }}
        registry-password: ${{ secrets.HARBOR_PASSWORD }}

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4.6.2
      if: success()
      with:
        name: build-files
        path: build/
        retention-days: 7

  check-workflow-status:
    runs-on: kubernetes-runner
    permissions:
      contents: read
      actions: read
    steps:
    - name: Check Workflow Status
      id: check-workflow-status
      uses: eidp/actions-common/check-workflow-status@v0.4.0
      with:
        jobs: 'build'
        github-token: ${{ secrets.GITHUB_TOKEN }}
