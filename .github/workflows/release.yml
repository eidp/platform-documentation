name: release

on:
  push:
    tags:
    - '*.*.*'

jobs:
  release:
    runs-on: kubernetes-runner

    permissions:
      contents: read
      actions: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: Fetch commit version
      id: fetch-commit-version
      uses: eidp/actions-semver/fetch-commit-version@63e0b74c4b0198e4dd764b2c73c5c447bbb1b29a # v0.3.0
      with:
        workflow-name: build

    - name: Get commit SHA
      id: commit-sha
      uses: eidp/actions-common/commit-sha@b1ae9db377e1e789ec4583ef3bf7a022ae4bfee4 # v1.1.1

    - name: Promote Docker Image
      id: promote-image
      uses: eidp/actions-docker/promote@aff1997ef07eb2ede4ca5c8b1ed9bffa24416d0a # v0.1.1
      with:
        image: ${{ vars.HARBOR_HOST }}/platform-documentation
        registry: ${{ vars.HARBOR_HOST }}
        registry-username: ${{ secrets.HARBOR_USERNAME }}
        registry-password: ${{ secrets.HARBOR_PASSWORD }}
        source-tag: ${{ steps.commit-sha.outputs.short-sha }}
        target-tag: '${{ github.ref_name }}'

    - name: Helm Promote
      uses: eidp/actions-helm/promote@1d05a75f7a7758dd8495bfc4e7b0c7deebc3b6e1 # v0.3.0
      with:
        chart: oci://${{ vars.HARBOR_HOST }}/charts/platform-documentation
        source-version: ${{ steps.fetch-commit-version.outputs.version }}
        target-version: '${{ github.ref_name }}'
        patch-docker-image: 'true'
        target-docker-image-version: '${{ github.ref_name }}'
        repo-host: oci://${{ vars.HARBOR_HOST }}/charts
        repo-user: ${{ secrets.HARBOR_USERNAME }}
        repo-password: ${{ secrets.HARBOR_PASSWORD }}
